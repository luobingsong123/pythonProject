<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回测记录查看器</title>
    
    <!-- 第三方库 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- 样式文件 -->
    <link href="{{ url_for('static', filename='css/backtest_viewer.css') }}" rel="stylesheet">
</head>
<body>
    <!-- AppBar -->
    <header class="app-bar">
        <h1 class="app-bar-title">回测记录查看器</h1>
    </header>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" data-tab="time-based">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">schedule</span>
                基于时间回测
            </button>
            <button class="tab" data-tab="backtrader">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">show_chart</span>
                遍历回测
            </button>
            <button class="tab" data-tab="data-update">
                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">sync</span>
                数据更新
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Time Based Panel -->
        <div id="time-based-panel" class="tab-panel active">
            <div class="tb-layout">
                <!-- Left Column -->
                <div class="tb-left-column">
                    <!-- Strategy Selector Panel -->
                    <div class="panel tb-strategy-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">filter_list</span>
                                策略选择
                            </div>
                        </div>
                        <div class="panel-content">
                            <div class="form-control">
                                <label class="form-label">策略名称</label>
                                <select id="tb-strategy-select" class="form-select">
                                    <option value="">请选择策略</option>
                                </select>
                            </div>
                            <button id="tb-search-btn" class="btn btn-primary" style="width: 100%; margin-top: 12px;">
                                <span class="material-icons" style="font-size: 18px;">search</span>
                                查询回测记录
                            </button>
                        </div>
                    </div>

                    <!-- Backtest Period Buttons -->
                    <div class="panel tb-periods-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">date_range</span>
                                回测结果列表
                            </div>
                            <span id="tb-periods-count" style="font-size: 12px; color: rgba(0,0,0,0.54);"></span>
                        </div>
                        <div class="panel-content" id="tb-periods-container">
                            <div class="empty-state">
                                <span class="material-icons empty-state-icon">event_note</span>
                                <div>请选择策略并查询</div>
                            </div>
                        </div>
                    </div>

                    <!-- Strategy Parameters -->
                    <div class="panel tb-params-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">settings</span>
                                策略参数
                            </div>
                        </div>
                        <div class="panel-content" id="tb-params-container">
                            <div class="empty-state">
                                <span class="material-icons empty-state-icon">tune</span>
                                <div>选择回测区间后显示策略参数</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="tb-right-column">
                    <!-- Stats Summary Panel -->
                    <div class="panel tb-stats-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">analytics</span>
                                回测结果信息<span id="tb-stats-period" style="font-size: 12px; color: rgba(0,0,0,0.54); margin-left: 8px;"></span>
                            </div>
                        </div>
                        <div class="panel-content">
                            <div id="tb-stats-container" class="tb-stats-grid">
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">总收益率</div>
                                    <div class="tb-stat-value" id="tb-stat-return">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">胜率</div>
                                    <div class="tb-stat-value" id="tb-stat-winrate">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">最大回撤</div>
                                    <div class="tb-stat-value" id="tb-stat-drawdown">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">夏普比率</div>
                                    <div class="tb-stat-value" id="tb-stat-sharpe">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">总交易次数</div>
                                    <div class="tb-stat-value" id="tb-stat-trades">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">交易天数</div>
                                    <div class="tb-stat-value" id="tb-stat-days">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">盈/亏次数</div>
                                    <div class="tb-stat-value" id="tb-stat-profit-loss">-</div>
                                </div>
                                <div class="tb-stat-item">
                                    <div class="tb-stat-label">总手续费</div>
                                    <div class="tb-stat-value" id="tb-stat-commission">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profit Chart -->
                    <div class="panel tb-chart-panel">
                        <div class="panel-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">show_chart</span>
                                收益曲线对比<span id="tb-chart-period" style="font-size: 12px; color: rgba(0,0,0,0.54); margin-left: 8px;"></span>
                            </div>
                            <div class="benchmark-btns" style="margin-bottom: 0;">
                                <span style="font-size: 11px; color: rgba(0,0,0,0.54); margin-right: 4px;">基准:</span>
                                <button class="benchmark-btn active" data-index="sh000001">上证指数</button>
                                <button class="benchmark-btn" data-index="sz399001">深证成指</button>
                                <button class="benchmark-btn" data-index="sh000300">沪深300</button>
                                <button class="benchmark-btn" data-index="sh000852">中证1000</button>
                            </div>
                        </div>
                        <div class="panel-content" style="flex: 1; min-height: 180px; padding: 8px 12px;">
                            <div id="tb-profit-chart" style="width: 100%; height: 100%;"></div>
                        </div>
                    </div>

                    <!-- Daily Records Table -->
                    <div class="panel tb-daily-panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px;">table_chart</span>
                                每日持仓记录<span id="tb-daily-count" style="font-size: 12px; color: rgba(0,0,0,0.54); margin-left: 8px;"></span>
                            </div>
                        </div>
                        <div class="panel-content" style="flex: 1; padding: 0; overflow: hidden;">
                            <div class="table-container" style="height: 100%;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>交易日期</th>
                                            <th>买入</th>
                                            <th>卖出</th>
                                            <th>总资产</th>
                                            <th>当日盈亏</th>
                                            <th>现金</th>
                                            <th>持仓</th>
                                            <th>持仓详情</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tb-daily-body">
                                        <tr>
                                            <td colspan="8">
                                                <div class="empty-state">
                                                    <span class="material-icons empty-state-icon">inbox</span>
                                                    <div>选择回测区间后显示每日持仓记录</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Update Panel -->
        <div id="data-update-panel" class="tab-panel">
            <div class="card" style="max-width: 800px; margin: 0 auto;">
                <div class="card-header">
                    <span class="material-icons" style="font-size: 24px; color: #1976d2;">sync</span>
                    <span class="card-title">市场数据更新</span>
                </div>
                <div class="card-content">
                    <div style="margin-bottom: 24px;">
                        <p style="color: rgba(0,0,0,0.6); margin-bottom: 16px; line-height: 1.6;">
                            点击下方按钮将更新股票日线数据和5分钟线数据。数据来源为 Baostock，更新范围从数据库中最新的日期到最新的交易日。
                        </p>
                        <div style="background: #fff3e0; padding: 12px 16px; border-radius: 4px; border-left: 4px solid #ff9800; margin-bottom: 20px;">
                            <span class="material-icons" style="font-size: 18px; vertical-align: middle; color: #ff9800; margin-right: 8px;">warning</span>
                            <span style="color: #e65100; font-size: 13px;">更新过程可能需要较长时间，请耐心等待。更新期间请勿关闭页面。</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 24px;">
                        <button id="update-data-btn" class="btn btn-primary" style="padding: 12px 32px;">
                            <span class="material-icons" style="font-size: 20px;">play_arrow</span>
                            开始更新
                        </button>
                        <div id="update-status" style="display: none; align-items: center; gap: 8px;">
                            <span class="material-icons" style="animation: spin 1s linear infinite; color: #1976d2;">refresh</span>
                            <span id="update-status-text" style="color: #1976d2; font-weight: 500;">正在更新...</span>
                        </div>
                    </div>

                    <div id="update-result" style="display: none;">
                        <div style="margin-bottom: 12px;">
                            <span class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 6px; color: rgba(0,0,0,0.54);">history</span>
                            <span style="font-size: 14px; color: rgba(0,0,0,0.87); font-weight: 500;">更新日志</span>
                        </div>
                        <div id="update-log" style="background: #fafafa; border: 1px solid #e0e0e0; border-radius: 4px; padding: 16px; max-height: 400px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 13px; line-height: 1.8; white-space: pre-wrap;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backtrader Panel -->
        <div id="backtrader-panel" class="tab-panel">
            <div class="backtrader-layout">
                <!-- Strategy & Stock Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">策略与股票选择</div>
                        <div class="form-control" style="margin-bottom: 8px;">
                            <select id="bt-strategy-select" class="form-select">
                                <option value="">请选择策略</option>
                            </select>
                        </div>
                        <div class="search-box">
                            <input type="text" id="bt-stock-search" class="form-input" placeholder="证券代码（可选）">
                            <button id="bt-search-btn" class="btn btn-primary" style="padding: 8px 16px;">查询</button>
                        </div>
                    </div>
                    <div class="panel-content" id="bt-stocks-list">
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">inbox</span>
                            <div>请选择策略并查询</div>
                        </div>
                    </div>
                    <!-- 分页控件 -->
                    <div class="pagination-container" id="bt-pagination" style="display: none;">
                        <button class="pagination-btn" id="bt-prev-page" disabled>
                            <span class="material-icons">chevron_left</span>
                        </button>
                        <span class="pagination-info" id="bt-page-info">1/1</span>
                        <button class="pagination-btn" id="bt-next-page" disabled>
                            <span class="material-icons">chevron_right</span>
                        </button>
                    </div>
                </div>

                <!-- Backtest Periods Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">回测记录</div>
                        <div id="bt-selected-stock" style="font-size: 12px; color: rgba(0,0,0,0.54);"></div>
                    </div>
                    <div class="panel-content" id="bt-periods-list">
                        <div class="empty-state">
                            <span class="material-icons empty-state-icon">show_chart</span>
                            <div>请在左侧选择股票</div>
                        </div>
                    </div>
                </div>

                <!-- Chart Panel -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">K线图</div>
                        <div id="bt-chart-info" style="font-size: 12px; color: rgba(0,0,0,0.54);"></div>
                    </div>
                    <div class="chart-container" id="bt-kline-chart"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript 模块 -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tabs.js') }}"></script>
    <script src="{{ url_for('static', filename='js/time_based_panel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/backtrader_panel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/data_update_panel.js') }}"></script>
    <script src="{{ url_for('static', filename='js/kline_chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
